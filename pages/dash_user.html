{% extends "base.html" %}
{% block title %}User Dashboard{% endblock %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js"></script>
<div class="container-fluid pt-4" style="min-height: calc(80vh - 120px); padding-left: 5%; padding-right: 5%;">
  <h1 class="pb-2">User Dashboard</h1>
  <div class="d-flex justify-content-between align-items-center">
    <h3>Welcome, {{ current_user.fname }}</h3>
    <h3 style="margin-left: 55%;">{{"Market Status - " ~ status}}</h3>
    <h3>{{ current_time }} ({{timezone}})</h3>
  </div>
  <div class="d-flex">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'warning' if category == 'warning' else category }} alert-dismissible fade show mb-3 mt-4" role="alert" style="width: 30%;">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <div class="row" style="min-height: calc(80vh - 120px); max-height: calc(80vh - 120px); height: calc(80vh - 120px);">

    <!-- Left side -->
    <div class="col-md-5 d-flex flex-column" style="height: 100%;">
      <div class="row d-flex">
        <div class="col-md-4 pb-3" style="height: 100%;">
          <div class="mb-3 mt-3 secondary d-flex flex-column align-items-start p-3 rounded" style="height: 90%;">
            <h3 class="mb-1">Balance:</h3>
            <h2 class="mb-3">${{ "%.2f"|format(current_user.balance) }}</h2>
            <form action="{{ url_for('add_funds') }}">
              <button type="submit" class="btn btn-primary">Add funds</button>
            </form>
          </div>
        </div>
        <div class="col-md-6 pb-3" style="height: 100%;">
          <div class="mb-3 mt-3 secondary d-flex flex-column align-items-start p-3 rounded" style="height: 90%;">
            <h3 class="mb-1">Portfolio Value:</h3>
            {% set prev_total = (current_user.previous_portfolio_value if current_user.is_authenticated else None) %}

            <h2 class="mb-3">${{  "%.2f"|format(portfolio_value)  }}
              {% if prev_total is not none and prev_total > 0 %}
                {% set total_pct = ((portfolio_value - prev_total) / prev_total) * 100 %}
                {% if total_pct > 0 %}
                  <small class="ms-2" style="color: rgb(145, 255, 145);">({{ '%+.2f'|format(total_pct) }}%)</small>
                {% elif total_pct < 0 %}
                  <small class="ms-2" style="color: rgb(255, 145, 145);">({{ '%+.2f'|format(total_pct) }}%)</small>
                {% else %}
                  <small class="ms-2">({{ '%+.2f'|format(total_pct) }})%</small>
                {% endif %}
              {% else %}
                <small class="ms-2">N/A</small>
              {% endif %}
            </h2>
          </div>
        </div>
      </div>

      <div class="row flex-grow-1 d-flex align-items-stretch flex-column flex-fill" style="height: 1%;">
        <div class="col-md-10 d-flex flex-column flex-grow-1" style="height: 1%;">
            <div class="mb-3 mt-3 secondary p-3 rounded d-flex flex-column flex-grow-1" style="height: 1%;">
            <h2 class=" mb-4 align-self-start">Transaction Summary:</h2>

            {%  if not transaction_summary  %}
            <div class="d-flex justify-content-center">
              <p class="text-center fs-4 mt-3 p-3" style="width: 40rem; background-color: #28282c; border-radius: 30px;">No detected transaction history.</p>
            </div>
              {%  else  %}
                <div class="table-responsive flex-grow-1 overflow-auto">
                  <table class="table table-striped text-center border-bottom border-dark">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Stock</th>
                        <th>Quantity</th>
                        <th>Transaction amount</th>
                      </tr>
                    </thead>
                    <tbody>
                    {%  for t in transaction_summary  %}
                      <tr>
                        <td>{{t.date.strftime('%m-%d-%Y | %H:%M')}}</td>
                        <td>{{t.stock.ticker}}</td>
                        <td>{{t.quantity}}</td>
                        {%  if t.transaction_type == "sell"  %}
                          <td style="color: rgb(145, 255, 145);">+${{"%.2f"|format(t.total_price)}}</td>
                        {%  else  %}
                          <td style="color: rgb(255, 145, 145);">-${{"%.2f"|format(t.total_price)}}</td>
                        {%  endif  %}
                      </tr>
                      {%  endfor  %}
                    </tbody>
                  </table>
                </div>
              {%  endif  %}
            </div>
          </div>
      </div>
    </div>

    <!-- Right side -->
    <div class="col-md-7 d-flex flex-column" style="height: 100%;">
      <div class="mb-3 mt-3 secondary p-3 rounded d-flex flex-column flex-grow-1" style="height: 1%;">
        <h2 class="mb-4 align-self-start">Portfolio:</h2>

        {%  if not user_portfolio  %}
        <div class="d-flex justify-content-center">
          <p class="text-center fs-4 mt-3 p-3" style="width: 40rem; background-color: #28282c; border-radius: 30px;">Your portfolio is empty! Browse through our <b>stock listings</b> to find your next investment.</p>
        </div>
          {%  else  %}
            <div class="table-responsive overflow-auto">
              <table class="table table-striped text-center border-bottom border-dark">
                <thead>
                  <tr>
                    <th>Symbol</th>
                    <th>Shares Owned</th>
                    <th>Market Value</th>
                    <th>Total Value</th>
                    <th>Quick Actions</th>
                  </tr>
                </thead>
                <tbody>
                {% for x in user_portfolio %}
                  <tr>
                    <td>{{ x.stock.ticker }}</td>
                    <td>{{ x.quantity }}</td>
                    <td>
                      ${{  "%.2f"|format(x.stock.price)  }}
                      {% if x.stock.previous_price is not none and x.stock.previous_price != 0 %}
                        {% set pct = ((x.stock.price - x.stock.previous_price) / x.stock.previous_price) * 100 %}
                        {% if pct > 0 %}
                          <small class="ms-2" style="color: rgb(145, 255, 145);">({{ '%+.2f'|format(pct) }}%)</small>
                        {% elif pct < 0 %}
                          <small class="ms-2" style="color: rgb(255, 145, 145);">({{ '%+.2f'|format(pct) }}%)</small>
                        {% else %}
                          <small class="ms-2">{{ '%+.2f'|format(pct) }}%</small>
                        {% endif %}
                      {% else %}
                        <small class="ms-2">N/A</small>
                      {% endif %}
                    </td>
                    <td>${{  "%.2f"|format(x.stock.price * x.quantity) }}</td>
                    <td>
                      {% if status == "Open" %}
                      <div id="quick_actions_{{ x.stock.id }}">
                        <button class="btn btn-sm btn-primary" hx-get="/quick_input?stock_id={{x.stock.id}}&action=buy" hx-target="#quick_actions_{{ x.stock.id }}">Buy</button>
                        <button class="btn btn-sm btn-primary" hx-get="/quick_input?stock_id={{x.stock.id}}&action=sell" hx-target="#quick_actions_{{ x.stock.id }}">Sell</button>
                      </div>

                      {% elif status == "Closed" %}
                      <div id="quick_actions_{{ x.stock.id }}">
                        <form action="{{ url_for('quick_input') }}">
                          <input type="hidden" value="closed" name="closed">
                          <button class="btn btn-sm btn-primary">Buy</button>
                          <button class="btn btn-sm btn-primary">Sell</button>
                        </form>
                      </div>

                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {%  endif  %}
      </div>
    </div>
  </div>
</div>

{% endblock %}