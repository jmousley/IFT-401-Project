{% extends "base.html" %}
{% block title %}User Dashboard{% endblock %}
{% block content %}


    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
<div class="container-fluid pt-4" style="min-height: calc(80vh - 120px); padding-left: 5%; padding-right: 5%;">
    
  <h1 class="pb-2">User Dashboard</h1>
  <div class="d-flex justify-content-between align-items-center">
    <h3>Welcome, {{ current_user.fname }}</h3>
    <h3 style="margin-left: 55%;">{{"Market Status - " ~ status}}</h3>
    <h3>{{ current_time }}</h3>
  </div>

  <div class="row" style="min-height: calc(80vh - 120px); max-height: calc(80vh - 120px); height: calc(80vh - 120px);">

    <!-- Left side -->
    <div class="col-md-5 d-flex flex-column" style="height: 100%;">
      <div class="row d-flex">
        <div class="col-md-4 pb-3" style="height: 100%;">
          <div class="mb-3 mt-3 secondary d-flex flex-column align-items-start p-3 rounded" style="height: 90%;">
            <h3 class="mb-1">Balance:</h3>
            <h2 class="mb-3">${{ "%.2f"|format(current_user.balance) }}</h2>
            <form action="{{ url_for('add_funds') }}">
              <button type="submit" class="btn btn-primary">Add funds</button>
            </form>
          </div>
        </div>
        <div class="col-md-6 pb-3" style="height: 100%;">
          <div class="mb-3 mt-3 secondary d-flex flex-column align-items-start p-3 rounded" style="height: 90%;">
            <h3 class="mb-1">Portfolio Value:</h3>
            <h2 class="mb-3">${{  "%.2f"|format(portfolio_value)  }}</h2>
          </div>
        </div>
      </div>

      <div class="row flex-grow-1 d-flex align-items-stretch flex-column flex-fill" style="height: 1%;">
        <div class="col-md-10 d-flex flex-column flex-grow-1" style="height: 1%;">
            <div class="mb-3 mt-3 secondary p-3 rounded d-flex flex-column flex-grow-1" style="height: 1%;">
            <h2 class=" mb-4 align-self-start">Transaction Summary:</h2>

            {%  if not transaction_summary  %}
            <div class="d-flex justify-content-center">
              <p class="text-center fs-4 mt-3 p-3" style="width: 40rem; background-color: #28282c; border-radius: 30px;">No detected transaction history.</p>
            </div>
              {%  else  %}
                <div class="table-responsive flex-grow-1 overflow-auto">
                  <table class="table table-striped text-center border-bottom border-dark">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Stock</th>
                        <th>Quantity</th>
                        <th>Transaction amount</th>
                      </tr>
                    </thead>
                    <tbody>
                    {%  for t in transaction_summary  %}
                      <tr>
                        <td>{{t.date.strftime('%m-%d-%Y | %H:%M')}}</td>
                        <td>{{t.stock.ticker}}</td>
                        <td>{{t.quantity}}</td>
                        {%  if t.transaction_type == "sell"  %}
                          <td style="color: rgb(145, 255, 145);">+${{"%.2f"|format(t.total_price)}}</td>
                        {%  else  %}
                          <td style="color: rgb(255, 145, 145);">-${{"%.2f"|format(t.total_price)}}</td>
                        {%  endif  %}
                      </tr>
                      {%  endfor  %}
                    </tbody>
                  </table>
                </div>
              {%  endif  %}
            </div>
          </div>
      </div>
    </div>

    <!-- Right side -->
    <div class="col-md-7 d-flex flex-column" style="height: 100%;">
      <div class="mb-3 mt-3 secondary p-3 rounded d-flex flex-column flex-grow-1" style="height: 1%;">
        <h2 class="mb-4 align-self-start">Portfolio:</h2>

        {%  if not user_portfolio  %}
        <div class="d-flex justify-content-center">
          <p class="text-center fs-4 mt-3 p-3" style="width: 40rem; background-color: #28282c; border-radius: 30px;">Your portfolio is empty! Browse through our <b>stock listings</b> to find your next investment.</p>
        </div>
          {%  else  %}
            <div class="table-responsive overflow-auto">
              <table class="table table-striped text-center border-bottom border-dark">
                <thead>
                  <tr>
                    <th>Symbol</th>
                    <th>Shares Owned</th>
                    <th>Market Value</th>
                    <th>Total Value</th>
                    <th>Quick Actions</th>
                  </tr>
                </thead>
                <tbody>
                {% for x in user_portfolio %}
                  <tr>
                    <td>{{ x.stock.ticker }}</td>
                    <td>{{ x.quantity }}</td>
                    <td>${{  "%.2f"|format(x.stock.price)  }}</td>
                    <td>${{  "%.2f"|format(x.stock.price * x.quantity) }}</td>
                    <td>
                      <a href="{{ url_for('home') }}" class="btn btn-sm btn-primary">Buy</a>
                      <a href="{{ url_for('home') }}" class="btn btn-sm btn-primary">Sell</a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {%  endif  %}
      </div>
    </div>
  </div>
</div>

{% endblock %}